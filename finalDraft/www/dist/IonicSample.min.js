/*! Ionic Sample - v1.0.0 - 2015-12-06
* Copyright (c) 2015 SurrealRanch; Licensed  */
angular.module("starter",["ionic","starter.controllers","starter.services","LocalStorageModule","ngCordova","monospaced.elastic"]).constant("authKey","myAuthToken").constant("authApi","http://localhost:3000/").constant("bestKey","tqz962ccgbcpygds2tmpdem6").run(["$ionicPlatform",function(a){a.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]).config(["$stateProvider","$urlRouterProvider","localStorageServiceProvider","$httpProvider",function(a,b,c,d){d.interceptors.push("TokenInterceptor"),d.defaults.headers.post["Content-Type"]="application/json",c.setPrefix("g12-ionic-sample-1"),a.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.storelist",{url:"/storelist",views:{menuContent:{templateUrl:"templates/storelist.html",controller:"StoreListCtrl"}}}).state("app.store",{url:"/storelist/:storeId",views:{menuContent:{templateUrl:"templates/storedetail.html",controller:"StoreDetailCtrl"}}}).state("app.productsearch",{url:"/productsearch",views:{menuContent:{templateUrl:"templates/productsearch.html",controller:"ProductsCtrl"}}}).state("app.messagelist",{url:"/messagelist",views:{menuContent:{templateUrl:"templates/messagelist.html",controller:"MessageListCtrl"}}}).state("app.single",{url:"/messagelist/:playlistId",views:{menuContent:{templateUrl:"templates/playlist.html",controller:"MessageCtrl"}}}),b.otherwise("/app/storelist")}]),angular.module("starter.controllers",[]).controller("AppCtrl",["$scope","$window","$ionicModal","$timeout","AuthFactory","$rootScope","$cordovaOauth",function(a,b,c,d,e,f,g){f.LoggedIn=function(){return e.isLogged()},f.$on("showLoginModal",function(b,d,f,h){a=d||a,a.loginData={},c.fromTemplateUrl("templates/login.html",{scope:a}).then(function(b){a.modal=b,a.login()}),a.closeLogin=function(){a.modal.hide(),"function"==typeof f&&f()},a.login=function(){a.modal.show()},a.doLogin=function(){e.login(a.loginData.username,a.loginData.password),e.isLogged()&&a.modal.hide(),"function"==typeof h&&h()},a.googleLogin=function(){g.google("796871197870-vi5m57fcag4af1r5nb1849iv75f3tcni.apps.googleusercontent.com",["email"]).then(function(b){a.modal.hide(),console.log(JSON.stringify(b)),alert("SUCCESS: "+JSON.stringify(b)),e.setKey("GoogleLoginSuccess")},function(a){console.log(JSON.stringify(a)),alert("ERROR: "+JSON.stringify(a))})}}),f.loginFromMenu=function(){f.$broadcast("showLoginModal",a,null,function(){e.isLogged()&&(alert("Login SUCCESS"),a.modal.hide(),b.location.reload())})},f.logoutFromMenu=function(){e.logout(),b.location.reload()}}]).controller("ProductsCtrl",["$scope","$ionicSlideBoxDelegate","AuthFactory","BestBuy","Logger",function(a,b,c,d,e){a.searchData={},a.images=[],a.isLoggedOut=function(){return!c.isLogged()},a.doSearch=function(){return(a.searchData.manufacturer.length=0)?void alert("Manufacturer's name is mandatory"):void d.search(a.searchData).then(function(c){console.log(JSON.stringify(c)),e.debug("Search Response",JSON.stringify(c)),alert("Status: "+c.statusText+" data.total: "+c.data.total),a.images=[];for(var d=c.data.products,f=0;f<d.length;f++){var g=d[f];a.images.push({MediaUrl:g.image,name:g.name,sku:g.sku,salePrice:g.salePrice})}setTimeout(function(){b.slide(0),b.update(),a.$apply()})},function(a){console.log(JSON.stringify(a)),alert("ERROR: "+JSON.stringify(a))})}}]).controller("StoreListCtrl",["$scope","AuthFactory","$rootScope","Logger","Geolocation",function(a,b,c,d,e){var f;a.searchData={},a.items=[],a.status="Searching for Closest Stores",a.isLoggedOut=function(){return!b.isLogged()},b.isLogged()===!1?c.$broadcast("showLoginModal",a,null,function(){a.status="Searching",a.items=[],f=e.all()}):(a.status="Searching",a.items=[],f=e.all()),f.then(function(b){a.status="Find Stores",a.items=b},function(a){alert("Failed: "+a)},function(b){a.status=b}),a.doSearch=function(){var b=null;if(a.searchData.city)b=a.searchData.city;else if(!confirm("Find Stores closest to your location?"))return;a.status="Searching",a.items=[];var c=e.all(b);c.then(function(b){a.status="Find Stores",a.items=b},function(a){alert("Failed: "+a)},function(b){a.status=b})}}]).controller("StoreDetailCtrl",["$scope","$stateParams","Geolocation",function(a,b,c){var d=b.storeId;a.item=c.details(d)}]).controller("MessageListCtrl",["$scope","AuthFactory","$rootScope","Logger",function(a,b,c,d){a.items=[],a.isLoggedOut=function(){return!b.isLogged()},b.isLogged()===!1?c.$broadcast("showLoginModal",a,null,function(){a.items=d.all()}):a.items=d.all()}]).controller("MessageCtrl",["$scope","$stateParams","Logger",function(a,b,c){var d=b.playlistId;a.item=c.get(d)}]),angular.module("starter.services",[]).factory("AuthFactory",["localStorageService","authKey",function(a,b){return{isLogged:function(){return null==a.get(b)?!1:!0},login:function(c,d){"guest"!==c&&d.length>5?a.set(b,"LocalLoginSuccess"):alert("Incorrect user name or password")},setKey:function(c){a.set(b,c)},logout:function(){a.remove(b)}}}]).factory("TokenInterceptor",["localStorageService","authKey",function(a,b){return{request:function(c){if(c.headers=c.headers||{},"http://localhost:3000/playlists"===c.url){var d=a.get(b);null!=d?(c.headers.secretkey=d,console.log("ADD header: "+JSON.stringify(c))):console.log("No header: "+JSON.stringify(c))}return c},response:function(a){return a}}}]).factory("PlayLists",["$http","authApi",function(a,b){return{all:function(){return a.get(b+"playlists")}}}]).factory("BestBuy",["$http","bestKey",function(a,b){return{search:function(c){var d=c.manufacturer,e=c.shortDescription,f="http://api.bestbuy.com/v1/products((manufacturer="+d+"&search="+e+"))?show=name,sku,salePrice,image&format=json&apiKey="+b;return a.get(f)}}}]).factory("Geolocation",["$cordovaGeolocation","$q","$http","Logger","bestKey",function(a,b,c,d,e){var f=[];return{all:function(g){var h=null;if(h=b.defer(),g){h.notify("Getting stores in "+g);var i="http://api.bestbuy.com/v1/stores(city="+g+")?format=json&apiKey="+e;c.get(i).then(function(a){d.debug("Stores Response",JSON.stringify(a)),f=a.data.stores,h.resolve(f)},function(a){d.error("Error getting Storlist",JSON.stringify(a)),h.reject("Error getting Storlist - see Messages")})}else{var j={timeout:1e4,enableHighAccuracy:!1};a.getCurrentPosition(j).then(function(a){var b=a.coords.latitude,g=a.coords.longitude;h.notify("Getting locations close to lat:"+b+" long:"+g);var i="http://api.bestbuy.com/v1/stores(area("+b+","+g+",1000))?format=json&apiKey="+e;c.get(i).then(function(a){d.debug("Stores Response",JSON.stringify(a)),f=a.data.stores,h.resolve(f)},function(a){d.error("Error getting Storlist",JSON.stringify(a)),h.reject("Error getting Storlist - see Messages")})},function(a){d.error("Error getting Geolocation",JSON.stringify(a)),h.reject("Error getting Geolocation - see Messages")})}return h.promise},details:function(a){a=parseInt(a);for(var b=0;b<f.length;b++){var c=f[b];if(a===c.storeId)return c}return null}}}]).factory("Logger",["localStorageService",function(a){function b(b,d,e){var f=new Date,g="Date: "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+" @ "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds(),h=a.get("counter");c.push({id:h,datetime:g,msg:b,details:d,type:e}),a.set("storage",c),h++,a.set("counter",h)}var c;return c=a.get("storage")?a.get("storage"):[],a.get("counter")||a.set("counter",0),{all:function(){return c},get:function(a){a=parseInt(a);for(var b=0;b<c.length;b++){var d=c[b];if(d.id===a)return d}return null},debug:function(a,c){b(a,c,"DEBUG")},error:function(a,c){b(a,c,"ERROR")}}}]);